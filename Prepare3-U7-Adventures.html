<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Quest: 20 Questions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f0f4f8;
            color: #1a202c;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .timer-bar {
            transition: width 1s linear;
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .mic-pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .results-list::-webkit-scrollbar {
            width: 6px;
        }
        .results-list::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="game-container" class="w-full max-w-xl">
        <!-- Start Screen -->
        <div id="start-screen" class="glass-card p-8 rounded-3xl shadow-2xl text-center">
            <div class="mb-6 inline-flex p-4 bg-blue-100 text-blue-600 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold mb-4 text-gray-800">Adventure Quest</h1>
            <p class="text-gray-600 mb-8 italic">20 mixed challenges ‚Ä¢ 40s timer</p>
            
            <button id="start-btn" onclick="requestPermissionAndStart()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition transform active:scale-95 shadow-lg flex items-center justify-center space-x-2 mb-4">
                <span>Start New Quest</span>
            </button>

            <button onclick="openResultsList()" class="w-full bg-white border-2 border-blue-100 text-blue-600 font-bold py-3 rounded-xl hover:bg-blue-50 transition shadow-sm">
                View Student Results
            </button>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden glass-card p-6 md:p-8 rounded-3xl shadow-2xl relative overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <span id="progress-text" class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Question 1/20</span>
                <div class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="timer-text" class="font-mono font-bold text-orange-600 text-lg">40</span>
                </div>
            </div>
            
            <div class="w-full bg-gray-100 h-2 rounded-full mb-8">
                <div id="timer-bar" class="timer-bar bg-orange-500 h-2 rounded-full w-full"></div>
            </div>

            <div id="question-container" class="mb-8">
                <div id="question-type" class="text-xs font-bold text-blue-500 mb-2 uppercase tracking-widest">Question Type</div>
                <h2 id="question-text" class="text-2xl font-bold leading-tight text-gray-800"></h2>
            </div>

            <div id="interaction-area"></div>
            <div id="feedback" class="mt-4 h-6 text-center font-semibold text-sm"></div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden glass-card p-8 rounded-3xl shadow-2xl text-center">
            <h2 class="text-3xl font-bold mb-2">Quest Complete!</h2>
            <div id="final-score" class="text-5xl font-black text-blue-600 mb-6">0/20</div>
            
            <div id="save-section" class="mb-8 p-6 bg-gray-50 rounded-2xl">
                <p id="save-instruction" class="text-gray-600 mb-4 font-medium">Type your name to save your result:</p>
                <input type="text" id="student-name" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none mb-4 text-center text-lg" placeholder="Student Name">
                <button id="save-btn" onclick="saveResult()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl transition shadow-md disabled:opacity-50">
                    Save My Score
                </button>
            </div>

            <button onclick="location.reload()" class="text-gray-400 hover:text-gray-800 font-bold transition uppercase tracking-widest text-sm">
                Return to Home
            </button>
        </div>

        <!-- Names List Modal -->
        <div id="results-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-40">
            <div class="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Class Results</h2>
                    <button onclick="closeResultsList()" class="bg-gray-100 p-2 rounded-full text-gray-400 hover:text-black transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div id="results-history" class="overflow-y-auto space-y-3 pr-2 flex-1 results-list">
                     <p class="text-sm text-gray-400 italic text-center py-8">Connecting to database...</p>
                </div>
            </div>
        </div>

        <!-- Detail View Modal -->
        <div id="detail-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div class="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="detail-title" class="text-xl font-bold text-gray-800">Review Answers</h2>
                    <button onclick="closeDetails()" class="bg-gray-100 p-2 rounded-full text-gray-400 hover:text-black transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div id="detail-list" class="overflow-y-auto space-y-4 pr-2 flex-1 results-list">
                    <!-- Breakdown items go here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyBPWo3YtT4K3bJEhmT-kVVUgPBQ1Rgdhw4",
                authDomain: "prepare-3---u7---vocab-87f82.firebaseapp.com",
                projectId: "prepare-3---u7---vocab-87f82",
                storageBucket: "prepare-3---u7---vocab-87f82.firebasestorage.app",
                messagingSenderId: "738254830931",
                appId: "1:738254830931:web:edef36f08fd6a7b43a75a6"
            };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'adventure-quest-default';

        let user = null;
        let allResultsData = [];

        // Auth initialization
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (e) {
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth failed:", err);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) listenToResults();
        });

        function listenToResults() {
            if (!user) return;
            const resultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results');
            onSnapshot(resultsRef, (snapshot) => {
                const results = [];
                snapshot.forEach(doc => results.push({ id: doc.id, ...doc.data() }));
                results.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                allResultsData = results;
                renderResultsList();
            }, (err) => {
                console.error("Database connection error:", err);
                const container = document.getElementById('results-history');
                container.innerHTML = `<p class="text-sm text-red-400 italic text-center py-8">Access Denied. Check Firebase Rules.</p>`;
            });
        }

        window.openResultsList = () => { document.getElementById('results-modal').classList.remove('hidden'); };
        window.closeResultsList = () => { document.getElementById('results-modal').classList.add('hidden'); };

        function renderResultsList() {
            const container = document.getElementById('results-history');
            if (allResultsData.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-400 italic text-center py-8">No results recorded yet.</p>`;
                return;
            }
            container.innerHTML = allResultsData.map((res) => `
                <button onclick="window.viewDetails('${res.id}')" class="w-full flex justify-between items-center p-4 bg-white border border-gray-100 rounded-2xl hover:border-blue-300 transition shadow-sm text-left">
                    <div class="flex-1 overflow-hidden">
                        <span class="font-bold text-gray-800 block truncate">${res.studentName || 'Anonymous'}</span>
                        <div class="text-[10px] text-gray-400 uppercase font-black tracking-widest">${res.timestamp ? new Date(res.timestamp.seconds * 1000).toLocaleDateString() : 'Recent'}</div>
                    </div>
                    <div class="bg-blue-50 text-blue-600 font-black px-4 py-2 rounded-xl text-lg ml-2">
                        ${res.score}/20
                    </div>
                </button>
            `).join('');
        }

        window.viewDetails = (id) => {
            const res = allResultsData.find(r => r.id === id);
            if (!res) return;
            closeResultsList();
            document.getElementById('detail-title').innerText = `${res.studentName}'s Review`;
            const list = document.getElementById('detail-list');
            list.innerHTML = res.details.map((item, idx) => `
                <div class="p-4 rounded-2xl border-l-4 shadow-sm ${item.isCorrect ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}">
                    <div class="text-[10px] font-black text-gray-400 mb-1 uppercase tracking-tighter">Question ${idx + 1}</div>
                    <div class="text-sm font-bold mb-2 text-gray-800">${item.question}</div>
                    <div class="space-y-1">
                        <div class="text-xs">
                            <span class="text-gray-400 uppercase font-bold text-[9px]">User Answer:</span> 
                            <span class="font-semibold ${item.isCorrect ? 'text-green-700' : 'text-red-700'}">${item.userAnswer || '(Timed out)'}</span>
                        </div>
                        ${!item.isCorrect ? `
                        <div class="text-xs">
                            <span class="text-gray-400 uppercase font-bold text-[9px]">Correct:</span> 
                            <span class="font-semibold text-green-700">${item.correctAnswer}</span>
                        </div>` : ''}
                    </div>
                </div>
            `).join('');
            document.getElementById('detail-modal').classList.remove('hidden');
        };

        window.closeDetails = () => {
            document.getElementById('detail-modal').classList.add('hidden');
            openResultsList();
        };

        // --- SOUND SYSTEM ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSynthSound(freq, type, duration, volume = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + duration);
        }

        const sounds = {
            correct: () => {
                playSynthSound(523.25, 'sine', 0.2); // C5
                setTimeout(() => playSynthSound(659.25, 'sine', 0.3), 100); // E5
            },
            wrong: () => {
                playSynthSound(150, 'sawtooth', 0.4, 0.05);
                playSynthSound(120, 'sawtooth', 0.4, 0.05);
            },
            tick: () => playSynthSound(800, 'square', 0.05, 0.02),
            complete: () => {
                const notes = [523.25, 659.25, 783.99, 1046.50];
                notes.forEach((f, i) => setTimeout(() => playSynthSound(f, 'sine', 0.5), i * 150));
            }
        };

        // --- GAME LOGIC ---
        const MAX_TIME = 40;
        const activities = [
            { term: 'diving', emoji: 'ü§ø', meaning: 'Swimming deep underwater with breathing equipment' },
            { term: 'hiking', emoji: 'ü•æ', meaning: 'Walking for long distances in nature or mountains' },
            { term: 'horse riding', emoji: 'üêé', meaning: 'Sitting on and controlling a horse' },
            { term: 'camping', emoji: '‚õ∫', meaning: 'Staying in a tent or temporary shelter outdoors' },
            { term: 'kite surfing', emoji: 'ü™Å', meaning: 'Riding on water using a board and a large kite' },
            { term: 'paddle boarding', emoji: 'üèÑ‚Äç‚ôÇÔ∏è', meaning: 'Standing on a board and moving with a paddle' },
            { term: 'sailing', emoji: '‚õµ', meaning: 'Traveling on water in a boat powered by wind' },
            { term: 'zip wiring', emoji: 'üö†', meaning: 'Sliding down a cable while hanging from a harness' },
            { term: 'mountain biking', emoji: 'üöµ', meaning: 'Riding a bicycle over rough, hilly terrain' },
            { term: 'waterskiing', emoji: 'üéø', meaning: 'Being pulled across water by a boat while on skis' }
        ];

        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let currentRunDetails = [];
        let timerValue = MAX_TIME;
        let timerInterval = null;
        let recognition = null;
        let micAllowed = false;
        let voiceTimeout = null;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        window.requestPermissionAndStart = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                micAllowed = true;
            } catch (err) { micAllowed = false; }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            startGame();
        };

        function generateQuestions() {
            const qList = [];
            activities.forEach(act => {
                const distractors = shuffle(activities.filter(a => a.term !== act.term)).slice(0, 3).map(a => a.term);
                qList.push({ type: 'mc', question: act.meaning, correct: act.term, options: shuffle([...distractors, act.term]) });
            });
            const emojiBlacklist = ['hiking', 'paddle boarding', 'waterskiing', 'zip wiring'];
            activities.filter(a => !emojiBlacklist.includes(a.term)).forEach(act => {
                qList.push({ type: 'gap', question: `${act.emoji} ‚Äî Activity:`, correct: act.term });
            });
            const voices = [
                { phrase: "I enjoy diving", target: "i enjoy diving" },
                { phrase: "Go horse riding", target: "go horse riding" },
                { phrase: "Camping is fun", target: "camping is fun" },
                { phrase: "Let's go sailing", target: "let's go sailing" }
            ];
            voices.forEach(item => {
                qList.push({ type: 'recording', question: `Say:`, correct: item.target, displayPhrase: item.phrase });
            });
            return shuffle(qList);
        }

        function startGame() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
            }
            questions = generateQuestions();
            currentQuestionIndex = 0; score = 0; currentRunDetails = [];
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            const q = questions[currentQuestionIndex];
            const interaction = document.getElementById('interaction-area');
            const qText = document.getElementById('question-text');
            document.getElementById('feedback').innerText = '';
            interaction.innerHTML = '';
            document.getElementById('progress-text').innerText = `Question ${currentQuestionIndex + 1}/20`;
            
            if (q.type === 'mc') {
                qText.innerText = q.question;
                document.getElementById('question-type').innerText = 'Multiple Choice';
                q.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-4 mb-3 border-2 border-gray-100 rounded-2xl hover:border-blue-400 hover:bg-blue-50 transition font-semibold capitalize';
                    btn.innerText = opt;
                    btn.onclick = () => checkAnswer(opt, btn);
                    interaction.appendChild(btn);
                });
            } else if (q.type === 'gap') {
                qText.innerText = q.question;
                document.getElementById('question-type').innerText = 'Fill in the Gap';
                interaction.innerHTML = `<input type="text" id="gap-input" class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-blue-500 focus:outline-none text-lg mb-4 text-center capitalize" placeholder="..." autocomplete="off"><button id="gap-submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl hover:bg-blue-700 transition">Submit Answer</button>`;
                const input = document.getElementById('gap-input');
                input.focus();
                document.getElementById('gap-submit').onclick = () => checkAnswer(input.value.toLowerCase().trim());
                input.onkeypress = (e) => { if (e.key === 'Enter') checkAnswer(input.value.toLowerCase().trim()); };
            } else if (q.type === 'recording') {
                document.getElementById('question-type').innerText = 'Voice Check';
                qText.innerHTML = `Say clearly:<br/><span class="text-blue-600 text-3xl mt-2 block font-black">"${q.displayPhrase}"</span>`;
                interaction.innerHTML = `<div class="flex flex-col items-center"><button id="mic-btn" class="w-24 h-24 bg-blue-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-blue-600 transition mb-4 active:scale-95"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-20a3 3 0 00-3 3v10a3 3 0 006 0V3a3 3 0 00-3-3z" /></svg></button><p id="mic-status" class="text-gray-500 text-sm font-bold">Tap mic to speak</p><button id="retry-btn" class="mt-4 px-8 py-2 bg-gray-200 text-gray-700 font-black rounded-xl hover:bg-gray-300 hidden">Say Again</button><input type="text" id="mic-fallback" class="w-full mt-4 p-4 border-2 border-gray-100 rounded-2xl focus:border-blue-300 focus:outline-none text-center hidden" placeholder="Type here if mic fails"></div>`;
                const micBtn = document.getElementById('mic-btn');
                const micStatus = document.getElementById('mic-status');
                const retryBtn = document.getElementById('retry-btn');
                const startRec = () => { clearTimeout(voiceTimeout); retryBtn.classList.add('hidden'); micBtn.classList.add('mic-pulse', 'bg-red-500'); micStatus.innerText = "Listening..."; recognition.start(); };
                if (!recognition || !micAllowed) { micStatus.innerText = "Mic unavailable. Type phrase:"; document.getElementById('mic-fallback').classList.remove('hidden'); document.getElementById('mic-fallback').onkeypress = (e) => { if (e.key === 'Enter') checkAnswer(e.target.value.toLowerCase().trim()); }; }
                else { micBtn.onclick = startRec; retryBtn.onclick = startRec; recognition.onresult = (e) => { const res = e.results[0][0].transcript.toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()]/g,""); micBtn.classList.remove('mic-pulse', 'bg-red-500'); micStatus.innerText = `Heard: "${res}"`; retryBtn.classList.remove('hidden'); voiceTimeout = setTimeout(() => checkAnswer(res), 2000); }; }
            }
            resetTimer();
        }

        function resetTimer() {
            clearInterval(timerInterval); timerValue = MAX_TIME; updateTimerUI();
            timerInterval = setInterval(() => { 
                timerValue--; 
                updateTimerUI(); 
                if (timerValue <= 5 && timerValue > 0) sounds.tick();
                if (timerValue <= 0) { clearInterval(timerInterval); checkAnswer("", null, true); } 
            }, 1000);
        }

        function updateTimerUI() {
            const bar = document.getElementById('timer-bar');
            bar.style.width = `${(timerValue / MAX_TIME) * 100}%`;
            document.getElementById('timer-text').innerText = timerValue;
            bar.className = timerValue <= 10 ? 'timer-bar bg-red-500 h-2 rounded-full w-full' : 'timer-bar bg-orange-500 h-2 rounded-full w-full';
        }

        function checkAnswer(answer, element = null, timedOut = false) {
            clearInterval(timerInterval); clearTimeout(voiceTimeout); if (recognition) try { recognition.stop(); } catch(e) {}
            
            const q = questions[currentQuestionIndex];
            
            // Normalize both correct and answer by removing apostrophes for flexible check
            const normalizedCorrect = q.correct.toLowerCase().replace(/'/g, "");
            const normalizedAnswer = answer.toLowerCase().replace(/'/g, "");
            
            const isCorrect = normalizedAnswer.includes(normalizedCorrect) || 
                              (normalizedCorrect.length > 5 && normalizedAnswer.length > 5 && 
                              (normalizedAnswer.includes(normalizedCorrect) || normalizedCorrect.includes(normalizedAnswer)));
            
            currentRunDetails.push({ 
                question: q.type === 'mc' ? q.question : (q.displayPhrase || q.question), 
                userAnswer: answer, 
                correctAnswer: q.correct, 
                isCorrect: isCorrect && !timedOut 
            });
            
            const f = document.getElementById('feedback');
            if (isCorrect && !timedOut && answer.length > 0) { 
                score++; 
                sounds.correct();
                f.innerText = "Correct!"; 
                f.className = 'mt-4 h-6 text-center font-black text-sm text-green-500'; 
                if (element) element.classList.add('bg-green-100', 'border-green-500'); 
            }
            else { 
                sounds.wrong();
                f.innerText = timedOut ? `Time's up! It was: ${q.correct}` : `Incorrect! It was: ${q.correct}`; 
                f.className = 'mt-4 h-6 text-center font-black text-sm text-red-500'; 
                if (element) element.classList.add('bg-red-100', 'border-red-500'); 
                document.getElementById('quiz-screen').classList.add('shake'); 
            }
            
            document.querySelectorAll('#interaction-area button, #interaction-area input').forEach(el => el.disabled = true);
            setTimeout(() => { 
                document.getElementById('quiz-screen').classList.remove('shake'); 
                currentQuestionIndex++; 
                if (currentQuestionIndex < questions.length) loadQuestion(); 
                else {
                    sounds.complete();
                    showResults(); 
                }
            }, 2000);
        }

        function showResults() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = `${score}/20`;
            document.getElementById('save-instruction').innerText = "Enter your name to save results:";
            document.getElementById('save-btn').disabled = false;
        }

        window.saveResult = async () => {
            if (!user) { alert("Please wait for database connection."); return; }
            const nameField = document.getElementById('student-name');
            const instr = document.getElementById('save-instruction');
            const name = nameField.value.trim();
            if (!name) { instr.innerText = "‚ö†Ô∏è Please enter your name!"; instr.className = "text-red-500 font-bold mb-4"; return; }
            
            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.innerText = "Saving...";
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results'), { 
                    studentName: name, 
                    score: score, 
                    details: currentRunDetails, 
                    timestamp: serverTimestamp() 
                });
                document.getElementById('save-section').innerHTML = `<p class="text-green-600 font-black p-6 bg-green-50 rounded-2xl">Result Saved!</p>`;
            } catch (e) { 
                console.error(e);
                btn.disabled = false; btn.innerText = "Save My Score"; 
                instr.innerText = "Save failed. Check Firebase Rules."; 
            }
        };
    </script>
</body>
</html>
